#!/usr/bin/env bash

umask 077
set -euo pipefail
cd "$(dirname $0)/.."

[[ ${DEBUG:-0} == "1" ]] && \
  set -x

DOTFILES="${DOTFILES:-$HOME/src/dotfiles}"

BLUE="\033[0;34m"
NO_COLOR="\033[0m"
RED="\033[0;31m"

info() {
  printf "$BLUE${1:-}$NO_COLOR\n"
}

error() {
  printf "$RED${1:-}$NO_COLOR\n"
  exit 1
}

symlink() {
  [[ -z ${1:-} ]] && error "symlink(): No file to symlink."
  ln -sf "$DOTFILES/$1" "$HOME/.$1"
}

main() {
  local system="$(uname -s)"

  [[ "$system" == CYGWIN* ]] || [[ "$system" == MINGW* ]] && {
    info "You're running Windows. Proceeding with caution."

    [[ "$system" == CYGWIN* ]] && [[ ! "${CYGWIN:-}" == "winsymlinks:nativestrict" ]] && \
      error 'Set CYGWIN environment variable to `winsymlinks:nativestrict` in Windows settings and try again.'
    [[ "$system" == MINGW* ]] && [[ ! "${MSYS:-}" == "winsymlinks:nativestrict" ]] && \
      error 'Set MSYS environment variable to `winsymlinks:nativestrict` in Windows settings and try again.'

    set +e
    net session > /dev/null 2>&1
    [[ ! $? -eq 0 ]] && error "Admin rights is required to install dotfiles on Windows."
    set -e
  }

  info "Installing dotfiles..."

  symlink bashrc
  symlink profile
  symlink vimrc

  [[ ! -d "$HOME/.config/git" ]] && mkdir -p "$HOME/.config/git"
  ln -sf "$DOTFILES/config/git/config" "$HOME/.config/git/config"

  if [[ "$system" == CYGWIN* ]] || [[ "$system" == MINGW* ]]; then
    ln -sf "$DOTFILES/platform/windows/gitconfig" "$HOME/.config/git/config.platform"
  else
    ln -sf "$DOTFILES/platform/generic/gitconfig" "$HOME/.config/git/config.platform"
  fi

  [[ "$(uname -o)" == "Android" ]] && {
    symlink hushlogin

    [[ ! "$(readlink "$HOME/.termux")" == "$DOTFILES/termux" ]] && {
      symlink termux
    }
  }
}

main "$@"
